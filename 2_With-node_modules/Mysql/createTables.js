var mysql = require('mysql');
//https://alvarotrigo.com/blog/wait-1-second-javascript/
//https://learnsql.com/cookbook/how-to-create-a-table-with-a-foreign-key-in-sql/ 
function delay(milliseconds){
    return new Promise(resolve => {
        setTimeout(resolve, milliseconds);
    });
}
async function run(){
    console.log("Executed now");
    //create connection to db server
    var con1 = mysql.createConnection({
        host: "localhost",
        user: "RolandBenz",
        password: "Qqr***",
        database: "mydb"
    });
    /*connect to db server (with the db mydb) and create table*/
    con1.connect(function(err) {
        if (err) throw err;
        console.log("Connected!");
        var sql = "CREATE TABLE customers (name VARCHAR(255), address VARCHAR(255))";
        con1.query(sql, function (err, result) {
            if (err) throw err;
            console.log("Table created");
            //end connetion to db
            con1.end(function(err) {
                if (err) {
                return console.log('error:' + err.message);
                }
                console.log('Close the database connection.');
                //destroy connetion to db server
                con1.destroy();
            });
        });
    });
    await delay(1000);
    console.log("Executed after 1 seconds wait");
    //create connection to db server
    var con2 = mysql.createConnection({
        host: "localhost",
        user: "RolandBenz",
        password: "Qqr***",
        database: "mydb"
    });
    /*connect to db server (with the db mydb) and add field to db*/
    con2.connect(function(err) {
    if (err) throw err;
        console.log("Connected!");
        var sql = "ALTER TABLE customers ADD COLUMN id INT AUTO_INCREMENT PRIMARY KEY";
        con2.query(sql, function (err, result) {
            if (err) throw err;
            console.log("Table altered");
            //end connetion to db
            con2.end(function(err) {
                if (err) {
                return console.log('error:' + err.message);
                }
                console.log('Close the database connection.');
                //destroy connetion to db server
                con2.destroy();
            });
        });
    }); 
    await delay(1000);
    console.log("Executed after 2 seconds wait");
    //create connection to db server
    var con4 = mysql.createConnection({
        host: "localhost",
        user: "RolandBenz",
        password: "Qqr***",
        database: "mydb"
    });
    /*connect to db server (with the db mydb) and create table*/
    con4.connect(function(err) {
        if (err) throw err;
        console.log("Connected!");
        var sql = "CREATE TABLE products (id INT PRIMARY KEY, name VARCHAR(255))";
        con4.query(sql, function (err, result) {
            if (err) throw err;
            console.log("Table created");
            //end connetion to db
            con4.end(function(err) {
                if (err) {
                return console.log('error:' + err.message);
                }
                console.log('Close the database connection.');
                //destroy connetion to db server
                con4.destroy();
            });
        });
    });
    await delay(1000);
    console.log("Executed after 3 seconds wait");
    //create connection to db server
    var con3 = mysql.createConnection({
        host: "localhost",
        user: "RolandBenz",
        password: "Qqr***",
        database: "mydb"
    });
    /*connect to db server (with the db mydb) and create table*/
    con3.connect(function(err) {
        if (err) throw err;
        console.log("Connected!");
        //var sql = "CREATE TABLE users (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(255), favorite_product INT FOREIGN KEY REFERENCES products(id))";
        var sql = "CREATE TABLE users (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(255), favorite_product INT, FOREIGN KEY (favorite_product) REFERENCES products(id))";
        
        con3.query(sql, function (err, result) {
            if (err) throw err;
            console.log("Table created");
            //end connetion to db
            con3.end(function(err) {
                if (err) {
                return console.log('error:' + err.message);
                }
                console.log('Close the database connection.');
                //destroy connetion to db server
                con3.destroy();
            });
        });
    }); 
}
run();
